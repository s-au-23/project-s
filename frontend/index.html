<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthReport AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center p-6">

    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl overflow-hidden mt-10">
        <div class="bg-blue-600 p-8 text-white text-center">
            <h1 class="text-3xl font-bold">HealthReport AI ü©∫</h1>
            <p class="opacity-90 mt-2">Upload your PDF lab report for a simple explanation</p>
        </div>

        <div class="p-8">
            <div id="dropzone"
                class="border-2 border-dashed border-blue-200 rounded-2xl p-10 text-center bg-blue-50 hover:bg-blue-100 cursor-pointer transition-all">
                <input type="file" id="fileInput" accept=".pdf" class="hidden">
                <div id="fileInfo" class="text-blue-600 font-medium">
                    <p class="text-lg">Click to select or drag & drop PDF</p>
                </div>
            </div>

            <button onclick="processPDF()" id="actionBtn"
                class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-transform active:scale-95">
                Analyze Report
            </button>

            <button id="downloadBtn"
                class="hidden w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-transform active:scale-95">
                üì• Download PDF
            </button>

            <div id="loader" class="hidden mt-8 text-center">
                <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent">
                </div>
                <p class="text-blue-600 mt-2 font-medium">AI is calculating your score...</p>
            </div>

            <div id="resultBox" class="hidden mt-8 animate-fadeIn">
                <div
                    class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl mb-6 border border-blue-100 shadow-sm">
                    <div>
                        <h4 class="text-blue-900 font-bold text-lg">Wellness Score</h4>
                        <p class="text-blue-600 text-sm">AI health assessment</p>
                    </div>
                    <div class="bg-white px-4 py-2 rounded-xl shadow-inner border border-blue-100">
                        <span id="healthScore" class="text-4xl font-black text-blue-600">--</span>
                        <span class="text-blue-400 text-lg font-bold">/10</span>
                    </div>
                </div>

                <div id="aiOutput"
                    class="bg-slate-50 p-6 rounded-2xl border border-gray-100 text-gray-700 whitespace-pre-wrap text-base">
                </div>

                <div class="flex gap-4 mt-6 border-t pt-4">
                    <button onclick="window.print()" class="text-blue-600 text-sm font-semibold hover:underline">üñ®Ô∏è
                        Print</button>
                    <button onclick="resetApp()" class="text-red-500 text-sm font-semibold hover:underline">üîÑ
                        Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const fileInfo = document.getElementById('fileInfo');
        const downloadBtn = document.getElementById('downloadBtn');
        const actionBtn = document.getElementById('actionBtn');
        const loader = document.getElementById('loader');
        const resultBox = document.getElementById('resultBox');
        const aiOutput = document.getElementById('aiOutput');
        const healthScoreDisplay = document.getElementById('healthScore');

        dropzone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) fileInfo.innerHTML = `<p class="text-green-600">Selected: ${e.target.files[0].name}</p>`;
        });

        async function processPDF() {
            const file = fileInput.files[0];
            if (!file) return alert("Select a PDF first.");

            actionBtn.disabled = true;
            loader.classList.remove('hidden');
            resultBox.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('http://127.0.0.1:5000/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const rawText = data.analysis;

                    // REGEX: Find "SCORE: [number]"
                    const scoreMatch = rawText.match(/SCORE:\s*(\d+)/i);

                    let cleanSummary = rawText;
                    let displayScore = "N/A";

                    if (scoreMatch) {
                        displayScore = scoreMatch[1];
                        // Remove the SCORE line from the display text
                        cleanSummary = rawText.replace(/SCORE:\s*\d+/i, "").trim();

                        // Change Color based on score
                        if (displayScore >= 8) healthScoreDisplay.style.color = "#16a34a"; // Green
                        else if (displayScore >= 5) healthScoreDisplay.style.color = "#ca8a04"; // Yellow
                        else healthScoreDisplay.style.color = "#dc2626"; // Red
                    }

                    healthScoreDisplay.innerText = displayScore;
                    aiOutput.innerText = cleanSummary;
                    resultBox.classList.remove('hidden');
                    downloadBtn.classList.remove('hidden');
                } else {
                    alert(data.error || "Server error.");
                }
            } catch (err) {
                alert("Make sure backend is running!");
            } finally {
                actionBtn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        async function downloadResults() {
            const resultText = `WELLNESS SCORE: ${healthScoreDisplay.innerText}/10\n\n` + aiOutput.innerText;
            const response = await fetch('http://127.0.0.1:5000/download-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: resultText })
            });
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Health_Report.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
        }

        function resetApp() {
            fileInput.value = "";
            fileInfo.innerHTML = '<p class="text-lg">Click to select or drag & drop PDF</p>';
            resultBox.classList.add('hidden');
            downloadBtn.classList.add('hidden');
        }

        downloadBtn.addEventListener('click', downloadResults);
    </script>
</body>

</html>